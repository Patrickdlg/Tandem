#!/usr/bin/env bash

# Written by Donald Pomeroy and Varun Ravishankar

EXPECTED_ARGS=1
E_BADARGS=22

error_exit()
{
  echo "$1" >&2
  exit 1
}

walk_test() {
    #echo $1
    ant_out=$(ant walk -Dfile="$1")
    ant_out=$(echo $ant_out | sed 's/\(.*\)\(walk: \)//1' | sed 's/BUILD SUCCESSFUL//g' | sed 's/Total.*//g' | sed "s/\[java\]/\\`echo -e '\n\r'`\[Tandem\]/g")
    ant_out1=$ant_out
    ant_out1=$(echo $ant_out1 | sed 's/\s+//g' | sed 's/ *$//g' | sed 's/^ *//g')
    #echo $ant_out
    #echo ${#ant_out1}

    if [[ ${#ant_out1} == "0" ]]; then
    : #echo "GOOD"
    echo
    else
    echo "$ant_out"
    echo "ERROR"
    exit
    fi
}


#Check if a file is passed, if not fail

if [ $# -ne $EXPECTED_ARGS ]
then
  echo "Usage: `basename $0` {arg}"
  echo "COMPILATION FAILED"
  exit $E_BADARGS
fi

FILE=$1

#Check if the filename is valid .td

if [[ "$FILE" == *.td ]]
then
  : # echo "valid filename"
else
     echo "COMPILATION FAILED - invalid filename"
     exit
fi

if [ -f "$FILE" ]
then
     : #echo "the file exists"
else
    echo "COMPILATION FAILED - the file does not exist"
    exit
fi

#check java
#check ant 1.8
#check ruby 1.9.2

if type -p java &>/dev/null; then
    : #echo "found java executable in PATH"
    _java=java
elif [[ -n "$JAVA_HOME" ]] && [[ "$JAVA_HOME/bin/java" ]];  then
     : # echo "found java executable in JAVA_HOME"
    _java="$JAVA_HOME/bin/java"
else
    echo "COMPILATION FAILED - no java"
    exit
fi

if [[ "$_java" ]]; then
    version=$("$_java" -version 2>&1 | awk -F '"' '/version/ {print $2}')
     : #echo version "$version"
    if [[ "$version" > "1.5" ]]; then
      : #  echo "version is more than 1.5"
    else
        echo "COMPILATION FAILED - version is less than 1.5"
	exit
    fi
fi



if type -p ant&>/dev/null; then
     : #echo found ant executable in PATH
    _ant=ant
elif [[ "/usr/bin/env ant" ]];  then
    : #echo "found ant executable in ENV_ANT"
    _ant="usr/bin/env ant"
else
    echo "COMPILATION FAILED - no ant"
    exit
fi

if [[ "$_ant" ]]; then
    version=$("$_ant" -version 2>&1 | grep -e "1\.8\.[0-9]")
    : #echo version "$version"
    if [[ "$?" == "0" ]]; then
        : #echo "version is more than 1.8"
    else
        echo "COMPILATION FAILED - version is less than 1.8"
	exit
    fi
fi

#Make JRuby use Ruby 1.9

JRUBY_OPTS=--1.9


if type -p ruby &>/dev/null; then
   : # echo "found ruby executable in PATH"
    _ruby=ruby
elif [[ "/usr/bin/env ruby" ]];  then
   : #echo "found ruby executable in ENV"
    _ruby="/usr/bin/env ruby"
else
    echo "COMPILATION FAILED - no ruby"
    exit
fi

use_jruby=0

if [[ "$_ruby" ]]; then
    version=$("$_ruby" -v 2>&1 |grep -e "1\.9\.[2-9]" )
   # echo $?
    if [[ "$?" > "0" ]]; then
    use_jruby=1
    else
    : #echo "Passed Ruby Check"
    fi
fi


DIR=$(pwd)

#$(echo $IN | tr ";" "\n")

echo "compiling..."

a=$(ruby src/dependency.rb "$FILE" | sed 's/DELIM/\'$'\n/g' | sed 's/^ *//g')
b=$(ruby src/dependency.rb "$FILE")
#echo $a
#echo
#echo
#echo $b
#exit
OIFS="$IFS"
IFS=$'\n'
for x in $a
do
    #x=$(echo $x | sed -e "s/ /\\\ /g" | awk 'sub("..$", "")')
    x=$(echo $x | sed 's/^ *//g' | sed 's/ *$//g')
    #echo $x
    walk_test "$x"
done
IFS="$OIFS"
#exit

walk_test "$FILE"


ruby_file=${FILE%.*}

#run a different version of ruby based on ant rubyexec

if [[ "$_use_jruby" > 0 ]]; then
	java -jar lib/runtime/jruby-complete.jar --1.9 "$ruby_file"
	else
	ruby "$ruby_file".rb
fi



